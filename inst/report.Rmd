---
title: "Analysis Report Generated by TMSBrainApp"
output: html_document
params:
  plo: 'NULL'
  Rep: 'NULL'
---


```{R echo=FALSE,warnings=FALSE}

library(shiny)
library(shinyBS)
library(shinyWidgets)
library(shinydashboard)
library(readxl)
library(tidyverse)
# library(plyr)
library(plotly)
library(colorRamps)
library(lme4)
library(lmerTest)

# INLA REQUIREf
library(foreach)
library(sp)
library(splancs)
library(rgdal)
library(INLA)
library(geosphere)
library(igraph)
library(rmarkdown)
library(nima)
```


```{R echo=FALSE,warnings=FALSE}
dados <- (params[["plo"]])
Rep <- (params[["Rep"]])
```

### Hotspot Coordinate

```{R,echo=FALSE, warnings=FALSE}
####### CARD

        if ( !is.null(dados$output) ) {
            X = dados$prd.m %>% filter(value == max(value, na.rm=T)) %>% pull(Var1)
            Y = dados$prd.m %>% filter(value == max(value, na.rm=T)) %>% pull(Var2)
            Z = dados$prd.m %>% filter(value == max(value, na.rm=T)) %>% pull(value)
            paste("Hotspot coordinate [ X = ",round(X,4)," Y = ",Y," ]")
            
        }
  
####### Tests 
       #
```

### Hightest Posterior Density Credible Interval / Exceedance Probability

```{R, echo=FALSE, warnings=FALSE}

            aux = dados$output
            probb =  dados$probb
            hpd   = dados$hpd
            MEP   =  dados$MEP
        if ( !is.null(aux)& is.null(probb)) {
            
            paste0('HPD [  Low = ',round(hpd[1],4),' High = ',round(hpd[2],4), '  ]')
         
            
        }else if(!is.null(aux)& !is.null(probb)){
           paste0('[  Low = ',round(hpd[1],4),' High = ',round(hpd[2],4), '  ]')
           paste0('P( Y > ',MEP,') = ',round(probb ,4))
        }else{
           paste0('')
        }  
             
```

### Data location

```{R echo=FALSE, warnings=FALSE}
###### TMS BRAIN MAPPING
        #
        testq = dados$testq
        x.min = min(dados$testq$x); x.max = max(dados$testq$x); x.range = abs(x.max-x.min)
        y.min = min(dados$testq$y); y.max = max(dados$testq$y); y.range = abs(y.max-y.min)
        h = 0.25
        #    
        x.range = c(floor( x.min-h*x.range ), ceiling( x.max+h*x.range ))
        y.range = c(floor( y.min-h*y.range ), ceiling( y.max+h*y.range ))
        #    
      
        TMS = testq %>% 
            mutate(x = round(x, 0), y = round(y, 0)) %>% 
            group_by(x, y) %>% 
            summarise(mean = mean(r)) %>% 
            ggplot(aes(x, y, z = mean)) + stat_summary_2d() +
            
            scale_fill_gradientn(colours=matlab.like(20), na.value=NA) +
            labs(fill=NULL) +
            scale_x_continuous(breaks = seq(0,60,by=15)) +
            scale_y_continuous(breaks = seq(-40,20,by=15)) +
            coord_cartesian(xlim = x.range, ylim = y.range) +
            coord_fixed() +
            # ggtitle("TMS BRAIN MAPPING | MEAN PER X-Y COORDINATES") +
            theme_minimal() +
            theme(text = element_text(size=16),
                  legend.position = 'bottom',
                  legend.key.width = unit(2.0,"cm"))
        # 
        TMS 
       
```

### Testing Order

```{R echo=FALSE, warnings=FALSE}

        DB = dados$testq
        #    
        if ( input$Rep1 ) { 
            REP = unique(c(1,input$Rep))
        } else {
            REP = input$Rep
        }
        # REP = DB %>% pull(Rep) %>% unique()
        #
        DB.aux = 
            #
            tibble(i=REP) %>% 
            rowwise() %>% 
            mutate(
                rep = list(c(1:i)),
                data = list(
                    DB %>% 
                        filter(Rep %in% rep) %>% 
                        group_by(ID) %>% 
                        summarise(r = mean(r))
                )
            ) %>% 
            select(-rep) %>% 
            unnest(cols = data)
        #       
        TO = DB %>%  
            ggplot(aes(x=ID,y=r)) + 
            geom_boxplot(outlier.shape = NA) +
            geom_point(data = DB.aux, aes(colour = factor(i)), size = 3) +
            labs(colour = 'Replication', y = 'Summary Signal') +
            theme_minimal() +
            theme(
                legend.position = 'bottom',
                text = element_text(size=16),
                axis.text.x = element_text(angle = 45, hjust = 1)
            )
        TO
        #
```

### Hotspot

```{R echo=FALSE, warnings=FALSE}

        
        testq = dados$testq
        #     
        x.min = min(testq$x); x.max = max(testq$x); x.range = abs(x.max-x.min)
        y.min = min(testq$y); y.max = max(testq$y); y.range = abs(y.max-y.min)
        h = 0.25
        #    
        x.range = c(floor( x.min-h*x.range ), ceiling( x.max+h*x.range ))
        y.range = c(floor( y.min-h*y.range ), ceiling( y.max+h*y.range ))
        #
        # browser()
        G.HOTSPOT = 
            dados$prd.m %>% 
            ggplot() +
            geom_raster(aes(x=dados$prd.m$Var1, y=dados$prd.m$Var2, fill=dados$prd.m$value)) +
            
            scale_fill_gradientn(colours=matlab.like(20), na.value=NA) +
            labs(x='x', y='y', fill=NULL) +
            scale_x_continuous(breaks = seq(0,60,by=15)) +
            scale_y_continuous(breaks = seq(-40,20,by=15)) +
            coord_cartesian(xlim = x.range, ylim = y.range) +
            coord_fixed() +
            theme_minimal() +
            theme(text = element_text(size=16), 
                  legend.position  ='none',
                  legend.key.width = unit(2.0,"cm"))
        G.HOTSPOT
        #
```

### Replication Effect

```{R echo=FALSE, warnings=FALSE}
RRep <- dados$output$summary.random$Rep
        G.REPLICATION = 
           RRep %>% 
            ggplot() +
            geom_line(aes(x=RRep$ID, y=RRep$mean), size=1) +
            geom_hline(yintercept=c(0), colour='black', linetype='dashed') +
            labs(x='Replication', y='Effect') +
            theme_minimal() +
            theme(text = element_text(size=16))
        G.REPLICATION
        #
```

### Residual Quantiles

```{R echo=FALSE, warnings=FALSE}
####### 3 D plot
        #
        #prd.m = dados$prd.m
        #testq = dados$testq
        #
        #prd.m =
        #    prd.m %>%
        #    mutate(x.round = round(prd.m$Var1,0),
        #           y.round = round(prd.m$Var2,0))
        #
        #testq =
        #    testq %>%
        #    mutate(x.round = round(testq$x,0),
         #          y.round = round(testq$y,0))
        #
        #testq =
        #    testq %>%
        #    left_join( prd.m %>% select(value,x.round,y.round) , by = c('x.round','y.round') )
        #

        #PLOT.3D = plot_ly(testq, x = ~x, y = ~y, z = ~z, color = ~value, colors = matlab.like(20)) %>%
        #    add_markers(size=3, showlegend = FALSE)
        #PLOT.3D
        #dados$Resid
        ggplotly(qq_plot(dados$Resid))
        #
```

### Model Summary

```{R echo=FALSE, warnings=FALSE}

summary(dados$output)
```
